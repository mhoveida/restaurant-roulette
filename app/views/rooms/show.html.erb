<% content_for :body_class, "bg-black" %>

<div class="room-container" data-controller="room-spin" data-room-id="<%= @room.id %>">
  <!-- Page Header -->
  <div class="room-page-header">
    <h1 class="room-page-title">Room Waiting Area</h1>
  </div>

  <!-- Room Code Section -->
  <div class="preference-section">
    <h2>Share this code with your friends</h2>
    <p class="subtitle">Invite your friends to join using the room code below</p>

    <div class="room-code-display">
      <div class="room-code-label">Room Code</div>
      <div class="room-code-value">
        Room Code: <span class="code-value"><%= @room.code %></span>
      </div>
    </div>

    <button id="copyCodeBtn" class="button button-secondary" style="width: 100%; margin-top: 1rem;">
      üìã Copy Room Code
    </button>

    <div id="copyConfirmation" class="copy-confirmation" style="display:none; margin-top: 1rem; text-align: center; color: #22c55e; font-weight: 600;">
      Room code <%= @room.code %> copied to clipboard!
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("copyCodeBtn");
        const confirmation = document.getElementById("copyConfirmation");
        const code = "<%= @room.code %>";

        btn.addEventListener("click", () => {
          navigator.clipboard.writeText(code);
          confirmation.style.display = "block";
          setTimeout(() => (confirmation.style.display = "none"), 2500);
        });
      });
    </script>
  </div>

  <!-- Group Preferences Section -->
  <div class="preference-section">
    <h2>Group Preferences</h2>
    <p class="subtitle">Settings for this spin session</p>

    <div class="preference-grid">
      <div class="preference-item">
        <div class="preference-label">Host</div>
        <div class="preference-value"><%= @room.owner_name %></div>
      </div>

      <div class="preference-item">
        <div class="preference-label">Location</div>
        <div class="preference-value"><%= @room.location %></div>
      </div>

      <div class="preference-item">
        <div class="preference-label">Price Range</div>
        <div class="preference-value"><%= @room.price %></div>
      </div>
    </div>

    <div class="preference-item" style="grid-column: 1 / -1;">
      <div class="preference-label">Cuisines</div>
      <div class="cuisine-list">
        <% if @room.categories.is_a?(Array) %>
          <% @room.categories.each do |cuisine| %>
            <span class="cuisine-tag"><%= cuisine %></span>
          <% end %>
        <% else %>
          <span class="cuisine-tag"><%= @room.categories %></span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Members Section -->
  <div class="preference-section">
    <h2>Members in Room:</h2>
    <p class="subtitle"><%= @room.get_all_members.length %> <%= "person" if @room.get_all_members.length == 1 %><%= "people" if @room.get_all_members.length > 1 %> joined</p>

    <div class="members-list">
      <% @room.get_all_members.each do |member| %>
        <div class="member-item">
          <div class="member-avatar">üë§</div>
          <div class="member-info">
            <div class="member-name"><%= member[:name] %></div>
            <div class="member-type <%= member[:type] == 'host' ? 'host-badge' : 'guest-badge' %>">
              <% if member[:type] == 'host' %>
                <span>üè† Host</span>
              <% else %>
                <span>üë• Guest</span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Wheel Section -->
  <div class="preference-section wheel-container">
    <h2>Ready to Spin?</h2>
    <p class="subtitle">Click the button below to spin the wheel and discover your restaurant</p>

    <div class="wheel-section">
      <canvas data-room-spin-target="wheel" class="roulette-wheel"></canvas>
    </div>

    <button class="button button-primary" data-room-spin-target="spinButton" data-action="click->room-spin#readyToSpin">
      ‚ú® Ready to Spin?
    </button>
  </div>

  <!-- Group Voting Section -->
  <div data-controller="room-vote"
      data-room-id="<%= @room.id %>"
      data-voter-name="<%= current_user&.first_name || session[:guest_name] %>">

    <h2 style="margin-top: 2rem;">Group Voting</h2>
    <p class="subtitle">Vote for your favorite restaurants!</p>

    <div data-room-vote-target="list">
      <% if @room.spin_results.present? %>
        <% @room.spin_results.each do |restaurant| %>
          <div class="restaurant-card" data-restaurant-id="<%= restaurant["id"] %>">
            <div class="rc-body">
              <% if restaurant["image_url"].present? %>
                <img class="rc-img" src="<%= restaurant["image_url"] %>" alt="<%= restaurant["name"] %>">
              <% end %>
              <div class="rc-meta">
                <div class="rc-name"><%= restaurant["name"] %></div>
                <div class="rc-sub"><%= [restaurant["price"], restaurant["rating"]].compact.join(" ‚Ä¢ ") %></div>
              </div>
            </div>
            <div class="rc-actions">
              <button data-action="click->room-vote#vote"
                      data-restaurant-id="<%= restaurant["id"] %>"
                      data-value="up">üëç</button>
              <button data-action="click->room-vote#vote"
                      data-restaurant-id="<%= restaurant["id"] %>"
                      data-value="down">üëé</button>
              <span class="count-up"></span>
              <span class="count-down"></span>
            </div>
          </div>
        <% end %>
      <% else %>
        <p style="color: gray;">No restaurants spun yet. Click "Ready to Spin" above!</p>
      <% end %>
    </div>
  </div>

  <!-- Result Modal -->
  <div class="result-overlay" data-room-spin-target="resultModal" style="display: none;">
    <div class="result-modal">
      <button class="close-button" data-action="click->room-spin#closeResult">√ó</button>
      <div class="result-header">
        <h3>Your Restaurant</h3>
      </div>
      <div class="restaurant-result" data-room-spin-target="resultContent"></div>
    </div>
  </div>
</div>
