<% content_for :body_class, "bg-black" %>

<div class="room-container" data-controller="room-spin" 
     data-room-id="<%= @room.id %>"
     data-room-code="<%= @room.code %>"
     data-room-state="<%= @room.state %>"
     data-current-member-id="<%= @current_member_id %>"
     data-is-room-creator="<%= @is_room_creator %>">
  
  <!-- Page Header -->
  <div class="room-page-header">
    <h1 class="room-page-title">
      <% if @room.waiting? %>
        Room Waiting Area
      <% elsif @room.spinning? %>
        Taking Turns Spinning! ğŸ°
      <% elsif @room.revealing? %>
        Get Ready for the Big Reveal! ğŸ‰
      <% elsif @room.voting? %>
        Time to Vote! ğŸ—³ï¸
      <% elsif @room.complete? %>
        Winner Selected! ğŸŠ
      <% end %>
    </h1>
  </div>

  <!-- Room Code Section -->
  <div class="preference-section">
    <h2>Share this code with your friends</h2>
    <p class="subtitle">Invite your friends to join using the room code below</p>

    <div class="room-code-display">
      <div class="room-code-label">Room Code</div>
      <div class="room-code-value">
        Room Code: <span class="code-value"><%= @room.code %></span>
      </div>
    </div>

    <button class="button button-secondary" 
        data-action="click->room-spin#copyRoomCode"
        style="width: 100%; margin-top: 1rem;">
      ğŸ“‹ Copy Room Code
    </button>

    <div id="copyConfirmation" class="copy-confirmation" style="display:none; margin-top: 1rem; text-align: center; color: #22c55e; font-weight: 600;">
      Room code <%= @room.code %> copied to clipboard!
    </div>
  </div>

  <!-- Group Preferences Section -->
  <div class="preference-section">
    <h2>Group Preferences</h2>
    <p class="subtitle">Settings for this spin session</p>

    <div class="preference-grid">
      <div class="preference-item">
        <div class="preference-label">Room Creator</div>
        <div class="preference-value"><%= @room.owner_name %></div>
      </div>

      <div class="preference-item">
        <div class="preference-label">Location</div>
        <div class="preference-value"><%= @room.location %></div>
      </div>

      <div class="preference-item">
        <div class="preference-label">Price Range</div>
        <div class="preference-value"><%= @room.price %></div>
      </div>
    </div>

    <div class="preference-item" style="grid-column: 1 / -1;">
      <div class="preference-label">Cuisines</div>
      <div class="cuisine-list">
        <% if @room.categories.is_a?(Array) %>
          <% @room.categories.each do |cuisine| %>
            <span class="cuisine-tag"><%= cuisine %></span>
          <% end %>
        <% else %>
          <span class="cuisine-tag"><%= @room.categories %></span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Members Section -->
  <div class="preference-section">
    <h2>Members in Room:</h2>
    <p class="subtitle">
      <%= @room.get_all_members.length %> 
      <%= @room.get_all_members.length == 1 ? "person" : "people" %> joined
    </p>

    <div class="members-list" data-room-spin-target="membersList">
      <% @room.get_all_members.each do |member| %>
        <div class="member-item" data-member-id="<%= member[:id] %>">
          <div class="member-avatar">ğŸ‘¤</div>
          <div class="member-info">
            <div class="member-name"><%= member[:name] %></div>
            <div class="member-type <%= member[:type] == 'host' ? 'host-badge' : 'guest-badge' %>">
              <% if member[:type] == 'host' %>
                <span>ğŸ  Room Creator</span>
              <% else %>
                <span>ğŸ‘¥ Member</span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- WAITING PHASE -->
  <!-- ========================================== -->
  <% if @room.waiting? %>
    <div class="preference-section" data-room-spin-target="waitingSection">
      <!-- SHOW MEMBER COUNT -->
      <div style="background-color: rgba(254, 228, 64, 0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ‘¥</div>
        <h3 style="color: var(--color-yellow); font-size: 1.3rem; margin: 0;">
          <%= @room.get_all_members.length %> 
          <%= @room.get_all_members.length == 1 ? "person" : "people" %> in room
        </h3>
        <p style="color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem; font-size: 0.9rem;">
          Everyone in the room will get to spin!
        </p>
      </div>
      
      <h2>Ready to Start?</h2>
      <p class="subtitle">
        <strong>Everyone will take turns spinning!</strong><br>
        Your choices stay secret until everyone finishes spinning.<br>
        Then vote together on all options!
      </p>

      <% if @is_room_creator %>
        <button class="button button-primary" 
                data-action="click->room-spin#startSpinning"
                style="width: 100%; margin-top: 1rem;">
          âœ¨ Start Spinning!
        </button>
        <p style="text-align: center; margin-top: 1rem; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem;">
          ğŸ’¡ Wait for everyone to join before starting!
        </p>
      <% else %>
        <div style="text-align: center; padding: 2rem; background-color: rgba(255, 255, 255, 0.05); border-radius: 8px;">
          <p style="font-size: 1.1rem; color: rgba(255, 255, 255, 0.8);">
            â³ Waiting for <%= @room.owner_name %> to start spinning...
          </p>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- ========================================== -->
  <!-- SPINNING PHASE -->
  <!-- ========================================== -->
  <% if @room.spinning? %>
    <div class="preference-section" data-room-spin-target="spinningSection">
      <h2>Take Turns Spinning! ğŸ°</h2>
      
      <!-- CHECK IF USER IS IN TURN ORDER -->
      <% if @room.turn_order.include?(@current_member_id) %>
        <!-- User is in turn order - show normal spinning UI -->
        <p class="subtitle">
          <strong>Your spins are secret until everyone finishes!</strong><br>
          Options will be revealed when everyone completes their spin.
        </p>

        <!-- Turn Order Display -->
        <div class="turn-order-section" style="margin: 2rem 0;">
          <h3 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--color-yellow);">Turn Order:</h3>
          <div class="turn-order-list">
            <% @room.turn_order.each_with_index do |member_id, index| %>
              <% member = @room.get_member_by_id(member_id) %>
              <% is_current = index == @room.current_turn_index %>
              <% is_done = index < @room.current_turn_index %>
              
              <div class="turn-item <%= 'current-turn' if is_current %> <%= 'completed-turn' if is_done %>"
                  data-turn-index="<%= index %>"
                  data-member-id="<%= member_id %>">
                <div class="turn-number">
                  <% if is_done %>
                    âœ“
                  <% elsif is_current %>
                    â­
                  <% else %>
                    <%= index + 1 %>
                  <% end %>
                </div>
                <div class="turn-member-name"><%= member[:name] %></div>
                <div class="turn-status">
                  <% if is_done %>
                    <span class="status-done">Done</span>
                  <% elsif is_current %>
                    <span class="status-current">Current</span>
                  <% else %>
                    <span class="status-waiting">Waiting</span>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Spin Section -->
        <div class="wheel-section">
          <% if @room.is_my_turn?(@current_member_id) %>
            <div style="display: flex; flex-direction: column; align-items: center;">
              <!-- Your Turn Banner (Top) -->
              <div class="your-turn-banner" style="background-color: rgba(254, 228, 64, 0.15); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; text-align: center; width: 100%; max-width: 400px;">
                <h3 style="color: var(--color-yellow); font-size: 1.5rem; margin: 0;">
                  â­ Your Turn to Spin! â­
                </h3>
                <p style="margin: 0.5rem 0 0 0; color: rgba(255, 255, 255, 0.8);">
                  Click the wheel to add your secret option!
                </p>
              </div>
              
              <!-- Wheel (Middle) -->
              <div style="margin: 1rem 0;">
                <canvas data-room-spin-target="wheel" 
                        id="roulette-wheel"
                        width="300" 
                        height="300"
                        data-action="click->room-spin#spin"></canvas>
              </div>
              
              <!-- Button (Bottom) -->
              <div style="margin-top: 2rem;">
                <button class="button button-primary spin-button" 
                        data-action="click->room-spin#spin"
                        style="font-size: 1.1rem; padding: 15px 60px;">
                  ğŸ° Spin
                </button>
              </div>
            </div>
          <% else %>
            <% current_member = @room.current_turn_member %>
            <div class="waiting-for-turn" style="text-align: center; padding: 3rem 2rem; background-color: rgba(255, 255, 255, 0.03); border-radius: 8px;">
              <div class="spinning-animation" style="font-size: 4rem; margin-bottom: 1rem;">ğŸ°</div>
              <h3 style="color: var(--color-yellow); font-size: 1.3rem; margin-bottom: 0.5rem;">
                <%= current_member[:name] %> is spinning...
              </h3>
              <p style="color: rgba(255, 255, 255, 0.7); margin: 0;">
                â³ Waiting for your turn...
              </p>
              <% my_turn_index = @room.turn_order.index(@current_member_id) %>
              <% if my_turn_index && my_turn_index > @room.current_turn_index %>
                <p style="color: rgba(255, 255, 255, 0.5); margin-top: 1rem; font-size: 0.9rem;">
                  You're <%= my_turn_index - @room.current_turn_index %> 
                  <%= my_turn_index - @room.current_turn_index == 1 ? "turn" : "turns" %> away!
                </p>
              <% end %>
            </div>
          <% end %>
        </div>
        
      <% else %>
        <!-- LATE JOINER MESSAGE - User joined after spinning started -->
        <div style="text-align: center; padding: 3rem 2rem; background-color: rgba(254, 228, 64, 0.1); border-radius: 12px; border: 2px solid rgba(254, 228, 64, 0.3); margin: 2rem 0;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">â°</div>
          <h3 style="color: var(--color-yellow); font-size: 1.5rem; margin-bottom: 1rem;">
            You joined during an active round
          </h3>
          <p style="color: rgba(255, 255, 255, 0.8); font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem;">
            The current round is already in progress.<br>
            You'll be able to participate in the next round!<br>
            Sit tight and watch the action unfold! ğŸ¿
          </p>
          
          <!-- Show who's currently spinning -->
          <% current_member = @room.current_turn_member %>
          <div style="background-color: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <p style="color: rgba(255, 255, 255, 0.7); margin: 0;">
              Currently spinning: <strong style="color: var(--color-yellow);"><%= current_member[:name] %></strong>
            </p>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

    <!-- ========================================== -->
    <!-- REVEALING PHASE -->
    <!-- ========================================== -->
    <% if @room.revealing? %>
      <div class="preference-section reveal-section" data-room-spin-target="revealSection">
        <h2>Round <%= @room.current_round %> Complete! ğŸ‰</h2>
        
        <!-- CHECK IF USER WAS IN THIS ROUND -->
        <% if @room.turn_order.include?(@current_member_id) %>
          <!-- Normal revealing UI for participants -->
          <p class="subtitle" style="font-size: 1.2rem; color: var(--color-yellow);">
            Get ready for the big reveal!
          </p>
          
          <div class="countdown-container" style="text-align: center; padding: 3rem; background-color: rgba(254, 228, 64, 0.1); border-radius: 12px; margin: 2rem 0;">
            <div class="countdown-number" data-room-spin-target="countdown" style="font-size: 5rem; color: var(--color-yellow); font-weight: 700;">
              3
            </div>
            <p style="font-size: 1.2rem; color: rgba(255, 255, 255, 0.8); margin-top: 1rem;">
              Revealing options...
            </p>
          </div>

          <% if @is_room_creator %>
            <button class="button button-primary" 
                    data-action="click->room-spin#reveal"
                    style="width: 100%; max-width: 400px; margin: 0 auto; display: block;">
              ğŸŠ Reveal All Options!
            </button>
          <% end %>
          
        <% else %>
          <!-- LATE JOINER MESSAGE -->
          <div style="text-align: center; padding: 3rem 2rem; background-color: rgba(254, 228, 64, 0.1); border-radius: 12px; border: 2px solid rgba(254, 228, 64, 0.3); margin: 2rem 0;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">â°</div>
            <h3 style="color: var(--color-yellow); font-size: 1.5rem; margin-bottom: 1rem;">
              You joined after this round finished
            </h3>
            <p style="color: rgba(255, 255, 255, 0.8); font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem;">
              The spinning is complete and options are being revealed.<br>
              You'll be able to vote and participate in the next round!<br>
              Hang tight! ğŸ¿
            </p>
          </div>
        <% end %>
      </div>
    <% end %>

  <!-- ========================================== -->
  <!-- VOTING PHASE -->
  <!-- ========================================== -->
  <% if @room.voting? %>
    <div class="preference-section voting-section" data-room-spin-target="votingSection">
      <h2>Time to Vote! ğŸ—³ï¸</h2>
      
      <!-- EVERYONE CAN VOTE -->
      <% if @current_member_id.present? %>
        <!-- Normal voting UI for participants -->
        <p class="subtitle">
          Vote for your group's favorite restaurant!<br>
          <small style="color: rgba(255, 255, 255, 0.6);">Options are anonymous - vote based on what you like!</small>
        </p>

        <div class="voting-board" style="margin-top: 2rem;">
          <% @room.get_options_for_voting.each_with_index do |spin, index| %>
            <% restaurant = spin["restaurant"] %>
            <% vote_counts = @room.get_vote_counts %>
            <% votes = vote_counts[index] || 0 %>
            
            <div class="voting-option <%= 'selected-vote' if @room.get_member_vote(@current_member_id) == index %> <%= 'vote-confirmed' if @room.has_confirmed_vote?(@current_member_id) %>" 
              data-option-index="<%= index %>"
              data-action="click->room-spin#voteForOption"
              style="background-color: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative;">
              
              <div style="display: flex; gap: 1.5rem; align-items: start;">
                <!-- Restaurant Image -->
                <% if restaurant["image_url"].present? %>
                  <div style="flex-shrink: 0; width: 120px; height: 120px; border-radius: 8px; overflow: hidden;">
                    <img src="<%= restaurant["image_url"] %>" alt="<%= restaurant["name"] %>" 
                        style="width: 100%; height: 100%; object-fit: cover;">
                  </div>
                <% end %>

                <!-- Restaurant Info -->
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <h3 style="color: var(--color-text); font-size: 1.3rem; margin: 0;">
                      <%= restaurant["name"] %>
                    </h3>
                    <div class="vote-count" style="background-color: rgba(254, 228, 64, 0.2); color: var(--color-yellow); padding: 0.5rem 1rem; border-radius: 6px; font-weight: 700; font-size: 1.1rem;">
                      <%= votes %> <%= votes == 1 ? "vote" : "votes" %>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0.75rem;">
                    <div class="rating" style="color: var(--color-yellow); font-size: 0.9rem;">
                      â­ <%= restaurant["rating"] %>
                    </div>
                    <div class="price" style="color: var(--color-yellow); font-weight: 600;">
                      <%= restaurant["price"] %>
                    </div>
                  </div>

                  <% if restaurant["categories"].present? %>
                    <div class="cuisine-tags" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                      <% restaurant["categories"].first(3).each do |category| %>
                        <span style="background-color: rgba(254, 228, 64, 0.1); color: var(--color-yellow); padding: 0.3rem 0.7rem; border-radius: 4px; font-size: 0.85rem;">
                          <%= category %>
                        </span>
                      <% end %>
                    </div>
                  <% end %>

                  <div class="address" style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                    ğŸ“ <%= restaurant["address"] %>
                  </div>
                </div>
              </div>
            </div>
          <% end %> <!-- closes each_with_index loop -->
        </div> <!-- closes voting-board div -->
      <% end %> <!-- closes @current_member_id.present? if -->
    </div> <!-- closes voting-section div -->
  <% end %> <!-- closes @room.voting? if -->
  <!-- ========================================== -->
  <!-- COMPLETE PHASE (Winner Display) -->
  <!-- ========================================== -->
  <% if @room.complete? && @room.winner.present? %>
    <% restaurant = @room.winner["restaurant"] %>
    
    <div class="result-overlay" data-controller="winner-result">
      <div class="result-modal">
        <div class="result-header">
          <h3>ğŸ‰ You're going to:</h3>
        </div>

        <div class="restaurant-result">
          <% if restaurant["image_url"].present? %>
            <div class="restaurant-image">
              <img src="<%= restaurant["image_url"] %>" alt="<%= restaurant["name"] %>">
            </div>
          <% end %>

          <h2 class="restaurant-name"><%= restaurant["name"] %></h2>

          <!-- Rating -->
          <div class="restaurant-rating">
            <span class="stars"><%= "â˜…" * restaurant["rating"].to_i %><%= "â˜†" * (5 - restaurant["rating"].to_i) %></span>
            <span class="rating-value">(<%= restaurant["rating"] %>)</span>
          </div>

          <!-- Price and Categories -->
          <div class="restaurant-meta">
            <span class="price"><%= restaurant["price"] %></span>
            <% if restaurant["categories"].present? %>
              <div class="cuisine-list">
                <% restaurant["categories"].each do |category| %>
                  <span class="cuisine-tag"><%= category %></span>
                <% end %>
              </div>
            <% end %>
          </div>

          <!-- Address -->
          <div class="restaurant-address">
            <span class="address-icon">ğŸ“</span>
            <%= restaurant["address"] %>
          </div>

          <!-- Status -->
          <div class="restaurant-status">
            <% if restaurant["is_open_now"] %>
              <span class="status-open">Open</span>
              <% if restaurant["closing_time"].present? %>
                <span class="closing-time">Closes at <%= restaurant["closing_time"] %></span>
              <% end %>
            <% else %>
              <span class="status-closed">Closed</span>
            <% end %>
          </div>

          <!-- Review Count -->
          <% if restaurant["review_count"].present? %>
            <div class="review-count">
              <%= restaurant["review_count"] %> reviews
            </div>
          <% end %>
          
          <!-- Winner Info -->
          <!-- Winner Info -->
          <div style="background-color: rgba(254, 228, 64, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;">
            <p style="margin: 0; color: var(--color-yellow); font-size: 0.95rem;">
              Added by <strong><%= @room.winner["member_name"] %></strong> â€¢ 
              <%= @room.winner["votes"] %> of <%= @room.winner["total_votes"] %> votes
              <% if @room.winner["tie_broken"] %>
                <br><span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">
                  ğŸ² Tie between <%= @room.winner["tied_count"] %> options - randomly selected!
                </span>
              <% end %>
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="result-actions">
          <a href="https://www.google.com/maps/search/?api=1&query=<%= ERB::Util.url_encode(restaurant["address"]) %>" 
            target="_blank"
            class="button spin-again-button">
            ğŸ—ºï¸ View on Map
          </a>

          <button class="button share-button" 
                  data-action="click->room-spin#shareWinner"
                  data-restaurant-name="<%= restaurant["name"] %>"
                  data-restaurant-address="<%= restaurant["address"] %>"
                  data-restaurant-rating="<%= restaurant["rating"] %>"
                  data-restaurant-price="<%= restaurant["price"] %>">
            Share
          </button>
        </div>
      </div>
    </div>
  <% end %>
</div>